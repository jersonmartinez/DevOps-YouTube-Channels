name: Handle Channel Suggestion Issues

on:
  issues:
    types: [opened, edited]

jobs:
  process-channel-suggestion:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.title, '[CHANNEL') || contains(github.event.issue.body, 'Canal Sugerido')
    
    steps:
      - name: Add labels to channel suggestion
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            
            // Add appropriate labels
            const labels = ['channel-suggestion', 'needs-review'];
            
            // Check if it's in Spanish or English
            const body = context.payload.issue.body || '';
            if (body.includes('Idioma: EspaÃ±ol') || body.includes('Idioma: es')) {
              labels.push('spanish');
            } else if (body.includes('Idioma: English') || body.includes('Idioma: en')) {
              labels.push('english');
            }
            
            // Add category label if specified
            const categories = ['platform-engineering', 'devsecops', 'containers', 'cloud', 'automation', 'homelab'];
            for (const category of categories) {
              if (body.toLowerCase().includes(category.toLowerCase())) {
                labels.push(`category-${category}`);
                break;
              }
            }
            
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number,
              labels
            });
      
      - name: Welcome comment
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const author = context.payload.issue.user.login;
            
            const welcomeMessage = `## ðŸŽ‰ Â¡Gracias por tu sugerencia de canal!
            
            Hola @${author}, gracias por contribuir a **DevOps YouTube Channels**.
            
            ### ðŸ”„ PrÃ³ximos pasos:
            1. âœ… **Recibido**: Tu sugerencia ha sido registrada
            2. ðŸ” **RevisiÃ³n automÃ¡tica**: Verificando informaciÃ³n del canal
            3. ðŸ‘¥ **RevisiÃ³n manual**: Nuestro equipo evaluarÃ¡ la calidad
            4. âš¡ **AprobaciÃ³n**: Si cumple criterios, serÃ¡ agregado
            
            ### â±ï¸ Tiempo estimado: 5-7 dÃ­as hÃ¡biles
            
            ### ðŸ“‹ Criterios de evaluaciÃ³n:
            - Contenido DevOps/Cloud relevante y de calidad
            - Canal activo con videos recientes
            - InformaciÃ³n tÃ©cnicamente precisa
            - Valor educativo para la comunidad
            
            ### ðŸ†˜ Â¿Necesitas ayuda?
            - Consulta nuestra [GuÃ­a de ContribuciÃ³n](https://github.com/${owner}/${repo}/blob/main/CONTRIBUTING.md)
            - Ve los [criterios detallados](https://github.com/${owner}/${repo}/blob/main/contribute.html)
            
            Â¡Gracias por ayudar a hacer crecer la comunidad DevOps! ðŸš€
            
            *Este comentario fue generado automÃ¡ticamente por el sistema de contribuciÃ³n.*`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: welcomeMessage
            });
      
      - name: Extract channel information
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const body = context.payload.issue.body || '';
            
            // Try to extract channel URL for basic validation
            const urlMatch = body.match(/URL.*?:?\s*(https?:\/\/[^\s\n]+)/i);
            const channelUrl = urlMatch ? urlMatch[1] : null;
            
            if (channelUrl) {
              console.log(`Found channel URL: ${channelUrl}`);
              
              // Basic URL validation
              if (!channelUrl.includes('youtube.com')) {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number,
                  body: `âš ï¸ **Advertencia**: La URL proporcionada no parece ser de YouTube.\n\nURL detectada: \`${channelUrl}\`\n\nPor favor, verifica que sea una URL vÃ¡lida de canal de YouTube.`
                });
              } else {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number,
                  body: `âœ… **URL validada**: Se detectÃ³ una URL de YouTube vÃ¡lida.\n\nðŸ” **PrÃ³ximo paso**: Nuestro equipo revisarÃ¡ el contenido y calidad del canal.`
                });
              }
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: `âŒ **URL no encontrada**: No se pudo detectar una URL de canal en la descripciÃ³n.\n\nðŸ”§ **AcciÃ³n requerida**: Por favor, edita el issue e incluye la URL completa del canal de YouTube.`
              });
            }
      
      - name: Assign to maintainer
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            
            // Assign to the repository owner for review
            await github.rest.issues.addAssignees({
              owner,
              repo,
              issue_number,
              assignees: [owner]
            });
      
      - name: Update issue title if needed
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const title = context.payload.issue.title;
            
            // Ensure title has proper format
            if (!title.includes('[CHANNEL') && !title.includes('[CANAL')) {
              const body = context.payload.issue.body || '';
              const nameMatch = body.match(/Nombre del Canal.*?:?\s*(.+?)(?:\n|$)/i);
              const channelName = nameMatch ? nameMatch[1].trim() : 'Canal sin nombre';
              
              const newTitle = `[CHANNEL SUGGESTION] ${channelName}`;
              
              await github.rest.issues.update({
                owner,
                repo,
                issue_number,
                title: newTitle
              });
              
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: `ðŸ”„ **TÃ­tulo actualizado**: Se ha estandarizado el tÃ­tulo del issue para mejor organizaciÃ³n.\n\n**Nuevo tÃ­tulo**: ${newTitle}`
              });
            }

  notify-new-suggestion:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.title, '[CHANNEL') || contains(github.event.issue.body, 'Canal Sugerido')
    
    steps:
      - name: Create summary
        run: |
          echo "## ðŸ“º Nueva Sugerencia de Canal" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Issue**: #${{ github.event.issue.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**TÃ­tulo**: ${{ github.event.issue.title }}" >> $GITHUB_STEP_SUMMARY
          echo "**Autor**: @${{ github.event.issue.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "**Fecha**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” PrÃ³ximos pasos:" >> $GITHUB_STEP_SUMMARY
          echo "1. RevisiÃ³n automÃ¡tica completada" >> $GITHUB_STEP_SUMMARY
          echo "2. Asignado para revisiÃ³n manual" >> $GITHUB_STEP_SUMMARY
          echo "3. Etiquetas aplicadas" >> $GITHUB_STEP_SUMMARY
          echo "4. Comentarios de bienvenida enviados" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[Ver issue completo](https://github.com/${{ github.repository }}/issues/${{ github.event.issue.number }})" >> $GITHUB_STEP_SUMMARY 